name: Monorepo Deployment

on:
  push:
    branches: ["main"]

jobs:
  test-and-deploy:
    runs-on: self-hosted
    environment: prod

    steps:
      - name: Clean root-owned files from previous run
        run: |
          docker run --rm \
            -v "$GITHUB_WORKSPACE":/workspace \
            alpine:latest \
            sh -c "rm -rf /workspace/backend/target /workspace/backend/.m2 /workspace/target"

      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Create .env file from secrets
        run: |
          cat > .env << EOF
          DB_NAME=${{ vars.DB_NAME }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          DB_URL=${{ vars.DB_URL }}
          DB_USER=${{ vars.DB_USER }}
          DOMAIN=${{ vars.DOMAIN }}
          FRONTEND_URL=${{ vars.FRONTEND_URL }}
          JWT_EXPIRATION=${{ vars.JWT_EXPIRATION }}
          JWT_REFRESH_EXPIRATION=${{ vars.JWT_REFRESH_EXPIRATION }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          MAX_FUTURE_DAYS=${{ vars.MAX_FUTURE_DAYS }}
          RATE_LIMIT_MAX_SUBMITTED_FORMS=${{ vars.RATE_LIMIT_MAX_SUBMITTED_FORMS }}
          REACT_APP_API_BASE_URL=${{ vars.REACT_APP_API_BASE_URL }}
          SPRING_PROFILES_ACTIVE=${{ secrets.SPRING_PROFILES_ACTIVE }}
          EOF

      - name: Ensure SSL certificate exists
        run: |
          if [ ! -f /etc/letsencrypt/live/thesis.kghobad.ir/fullchain.pem ]; then
            echo "Obtaining SSL certificate..."
            # Stop anything on port 80 so certbot can use it
            docker compose -f docker-compose.prod.yml down --remove-orphans 2>/dev/null || true
            sudo certbot certonly \
              --standalone \
              -d thesis.kghobad.ir \
              --email kooshaghobadian@gmail.com \
              --agree-tos \
              --no-eff-email \
              --non-interactive
          else
            echo "âœ… SSL certificate already exists."
          fi

      - name: Build and Deploy
        run: |
          docker compose -f docker-compose.prod.yml down --remove-orphans 2>/dev/null || true
          docker compose -f docker-compose.prod.yml build
          docker compose -f docker-compose.prod.yml up -d

      - name: Clean up old images
        run: docker image prune -f

      - name: Wait and verify
        run: |
          sleep 30
          docker compose -f docker-compose.prod.yml ps
          docker compose -f docker-compose.prod.yml logs thesis-backend --tail=20
          docker compose -f docker-compose.prod.yml logs thesis-frontend --tail=20
