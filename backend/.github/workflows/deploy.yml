name: Backend Deployment

on:
  push:
    branches: [ "main" ]

jobs:
  test-and-deploy:
    runs-on: self-hosted

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Run Tests in Docker
        run: |
          docker run --rm \
            -v "$PWD":/app \
            -w /app \
            maven:3.9-eclipse-temurin-21 \
            mvn verify -B

      - name: Create .env file from secrets
        run: |
          cat > .env << EOF
          MYSQL_ROOT_PASSWORD=${{ secrets.MYSQL_ROOT_PASSWORD }}
          MYSQL_DATABASE=${{ secrets.MYSQL_DATABASE }}
          DB_USER=${{ secrets.DB_USER }}
          DB_PASSWORD=${{ secrets.DB_PASSWORD }}
          JWT_SECRET=${{ secrets.JWT_SECRET }}
          JWT_EXPIRATION=${{ secrets.JWT_EXPIRATION }}
          FRONTEND_URL=${{ secrets.FRONTEND_URL }}
          RATE_LIMIT_MAX_SUBMITTED_FORMS=${{ secrets.RATE_LIMIT_MAX_SUBMITTED_FORMS }}
          REACT_APP_API_BASE_URL=${{ secrets.REACT_APP_API_BASE_URL }}
          EOF

      - name: Build and Deploy with Docker Compose
        run: |
          docker compose down
          docker compose build --no-cache
          docker compose up -d

      - name: Clean up old images
        run: docker image prune -f

      - name: Show running containers
        run: docker compose ps

      - name: Show backend logs
        run: docker compose logs backend --tail=50